apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-user-service-overview
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
  annotations:
    grafana_folder: "Teams"
data:
  user-service-overview.json: |
    {
      "schemaVersion": 39,
      "version": 1,
      "title": "User Service Overview",
      "tags": ["team:user"],
      "time": {"from": "now-6h", "to": "now"},
      "templating": {
        "list": [
          {"name": "team", "type": "constant", "label": "team", "query": "user", "hide": 2},
          {"name": "service", "type": "constant", "label": "service", "query": "reciping-user-service", "hide": 2},
          {"name": "endpoint", "type": "custom", "label": "endpoint 선택하기",
           "query": "^/api/v1/users/signup$,^/api/v1/users/.*/created-at$,^/api/v1/users/me$,^/api/v1/mypage$,^/api/v1/mypage/bookmarks$,^/api/v1/auth/refresh$,^/login$",
           "includeAll": true, "allValue": ".*", "multi": true, "current": {"text": "All", "value": ["$__all"]}}
        ]
      },
      "panels": [
        {"type": "row", "title": "빠른 필터 [Quick Filters]", "collapsed": false, "gridPos": {"h":1, "w":24, "x":0, "y":0}},
        {"type": "text", "title": "endpoint 바로가기", "gridPos": {"h":2, "w":24, "x":0, "y":1},
         "options": {"mode": "markdown", "content": "[signup](?var-team=user&var-service=reciping-user-service&var-endpoint=%5E/api/v1/users/signup$) | [mypage](?var-team=user&var-service=reciping-user-service&var-endpoint=%5E/api/v1/mypage$) | [bookmarks](?var-team=user&var-service=reciping-user-service&var-endpoint=%5E/api/v1/mypage/bookmarks$)"}},
        {"type": "row", "title": "1️⃣ 트래픽·오류 [Traffic & Errors]", "collapsed": false, "gridPos": {"h":1, "w":24, "x":0, "y":3}},
        {
          "type": "timeseries",
          "title": "요청률 RPS (5m) (Requests/sec)",
          "gridPos": {"h":7, "w":12, "x":0, "y":1},
          "targets": [
            {"expr": "sum by (reciping_service) (rate(http_server_requests_seconds_count{namespace=\"reciping\",reciping_team=\"$team\",reciping_service=\"$service\",uri!~\"/actuator/.*\",uri=~\"$endpoint\"}[5m]))", "legendFormat": "{{reciping_service}}"}
          ]
        },
        {
          "type": "timeseries",
          "title": "오류율 (5m %) (Error Rate)",
          "gridPos": {"h":7, "w":12, "x":12, "y":1},
          "targets": [
            {"expr": "100 * ( ( sum by (reciping_service) (rate(http_server_requests_seconds_count{namespace=\"reciping\",reciping_team=\"$team\",reciping_service=\"$service\",status=~\"5..\",uri!~\"/actuator/.*\",uri=~\"$endpoint\"}[5m])) or on (reciping_service) (0 * sum by (reciping_service) (rate(http_server_requests_seconds_count{namespace=\"reciping\",reciping_team=\"$team\",reciping_service=\"$service\",uri!~\"/actuator/.*\",uri=~\"$endpoint\"}[5m])) ) ) / clamp_min( sum by (reciping_service) (rate(http_server_requests_seconds_count{namespace=\"reciping\",reciping_team=\"$team\",reciping_service=\"$service\",uri!~\"/actuator/.*\",uri=~\"$endpoint\"}[5m])), 1) )", "legendFormat": "{{reciping_service}}"}
          ]
        },
        {"type": "row", "title": "2️⃣ 지연·JVM (Latency & JVM)", "collapsed": false, "gridPos": {"h":1, "w":24, "x":0, "y":8}},
        {
          "type": "timeseries",
          "title": "HTTP 지연 P95 (초) (Latency P95)",
          "gridPos": {"h":7, "w":12, "x":0, "y":9},
          "targets": [
            {"expr": "histogram_quantile(0.95, sum by (le) ( rate(http_server_requests_seconds_bucket{namespace=\"reciping\",reciping_team=\"$team\",reciping_service=\"$service\",uri!~\"/actuator/.*\",uri=~\"$endpoint\"}[5m]) ))", "legendFormat": "P95"}
          ]
        },
        {
          "type": "timeseries",
          "title": "HTTP 지연 P99 (초) (Latency P99)",
          "gridPos": {"h":7, "w":12, "x":12, "y":9},
          "targets": [
            {"expr": "histogram_quantile(0.99, sum by (le) ( rate(http_server_requests_seconds_bucket{namespace=\"reciping\",reciping_team=\"$team\",reciping_service=\"$service\",uri!~\"/actuator/.*\",uri=~\"$endpoint\"}[5m]) ))", "legendFormat": "P99"}
          ]
        },
        {"type": "row", "title": "3️⃣ 인스턴스·재시작 [Instances & Restarts]", "collapsed": false, "gridPos": {"h":1, "w":24, "x":0, "y":16}},
        {
          "type": "timeseries",
          "title": "실행 중 인스턴스 (Instances Up)",
          "gridPos": {"h":6, "w":12, "x":0, "y":17},
          "targets": [
            {"expr": "sum by (pod) (up{namespace=\"reciping\",reciping_service=\"$service\"})", "legendFormat": "{{pod}}"}
          ]
        },
        {
          "type": "timeseries",
          "title": "컨테이너 재시작 (5m) (Container Restarts)",
          "gridPos": {"h":6, "w":12, "x":12, "y":17},
          "targets": [
            {"expr": "sum by (pod) (increase(kube_pod_container_status_restarts_total{namespace=\"reciping\"}[5m]))", "legendFormat": "{{pod}}"}
          ]
        },
        {"type": "row", "title": "4️⃣ 엔드포인트 TopN (Endpoints)", "collapsed": false, "gridPos": {"h":1, "w":24, "x":0, "y":23}},
        {
          "type": "timeseries",
          "title": "Top RPS (엔드포인트)",
          "gridPos": {"h":7, "w":8, "x":0, "y":24},
          "targets": [
            {"expr": "topk(10, sum by (uri) (rate(http_server_requests_seconds_count{namespace=\"reciping\",reciping_team=\"$team\",reciping_service=\"$service\",uri!~\"/actuator/.*\",uri=~\"$endpoint\"}[5m])))", "legendFormat": "{{uri}}"}
          ]
        },
        {
          "type": "timeseries",
          "title": "Top 오류율 (엔드포인트, %)",
          "gridPos": {"h":7, "w":8, "x":8, "y":24},
          "targets": [
            {"expr": "topk(10, 100 * ( ( sum by (uri) (rate(http_server_requests_seconds_count{namespace=\"reciping\",reciping_team=\"$team\",reciping_service=\"$service\",status=~\"5..\",uri!~\"/actuator/.*\",uri=~\"$endpoint\"}[5m])) or on (uri) (0 * sum by (uri) (rate(http_server_requests_seconds_count{namespace=\"reciping\",reciping_team=\"$team\",reciping_service=\"$service\",uri!~\"/actuator/.*\",uri=~\"$endpoint\"}[5m])) ) ) / clamp_min( sum by (uri) (rate(http_server_requests_seconds_count{namespace=\"reciping\",reciping_team=\"$team\",reciping_service=\"$service\",uri!~\"/actuator/.*\",uri=~\"$endpoint\"}[5m])), 1) ))", "legendFormat": "{{uri}}"}
          ]
        },
        {
          "type": "timeseries",
          "title": "Top P95 (엔드포인트, 초)",
          "gridPos": {"h":7, "w":8, "x":16, "y":24},
          "targets": [
            {"expr": "topk(10, histogram_quantile(0.95, sum by (uri,le) ( rate(http_server_requests_seconds_bucket{namespace=\"reciping\",reciping_team=\"$team\",reciping_service=\"$service\",uri!~\"/actuator/.*\",uri=~\"$endpoint\"}[5m]) )))", "legendFormat": "{{uri}}"}
          ]
        }
      ]
    }

