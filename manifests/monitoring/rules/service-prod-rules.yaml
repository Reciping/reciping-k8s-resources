apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: service-prod-rules
  namespace: monitoring
spec:
  groups:
    # 1) ê°€ìš©ì„±/ì˜¤ë¥˜ìœ¨
    - name: http-availability
      rules:
        - alert: ServiceErrorRateHighWarning
          expr: |
            (
              sum by (reciping_team,reciping_service) (
                rate(http_server_requests_seconds_count{status=~"5..",uri!~"/actuator/.*"}[5m])
              )
              /
              sum by (reciping_team,reciping_service) (
                rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m])
              )
            ) > 0.05
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "[ğŸš¨ê²½ê³  - warning] 5xx ì˜¤ë¥˜ìœ¨ ë†’ìŒ"
            description: "íŒ€={{ $labels.reciping_team }}, ì„œë¹„ìŠ¤={{ $labels.reciping_service }}ì˜ 5xx ì˜¤ë¥˜ìœ¨ì´ 10ë¶„ ë™ì•ˆ 5%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."

        - alert: ServiceErrorRateHighCritical
          expr: |
            (
              sum by (reciping_team,reciping_service) (
                rate(http_server_requests_seconds_count{status=~"5..",uri!~"/actuator/.*"}[5m])
              )
              /
              sum by (reciping_team,reciping_service) (
                rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m])
              )
            ) > 0.10
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "[ğŸš¨ì¹˜ëª…ì  - critical] 5xx ì˜¤ë¥˜ìœ¨ ë§¤ìš° ë†’ìŒ"
            description: "íŒ€={{ $labels.reciping_team }}, ì„œë¹„ìŠ¤={{ $labels.reciping_service }}ì˜ 5xx ì˜¤ë¥˜ìœ¨ì´ 5ë¶„ ë™ì•ˆ 10%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."

        - alert: ServiceInstancesDown
          expr: |
            min by (reciping_team,reciping_service) (up{namespace="reciping"}) == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "[ğŸš¨ì¹˜ëª…ì  - critical] ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ ë‹¤ìš´"
            description: "íŒ€={{ $labels.reciping_team }}, ì„œë¹„ìŠ¤={{ $labels.reciping_service }}ì˜ ëª¨ë“  ìŠ¤í¬ë ˆì´í”„ ëŒ€ìƒì´ Down ìƒíƒœì…ë‹ˆë‹¤."

    # 2) ì§€ì—° ì‹œê°„ (í¼ì„¼íƒ€ì¼)
    - name: http-latency
      rules:
        - alert: ServiceLatencyP95High
          expr: |
            histogram_quantile(0.95,
              sum by (le,reciping_team,reciping_service) (
                rate(http_server_requests_seconds_bucket{uri!~"/actuator/.*"}[5m])
              )
            ) > 0.5
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "[ğŸš¨ê²½ê³  - warning] P95 ì§€ì—° ì‹œê°„ ë†’ìŒ (>500ms)"
            description: "íŒ€={{ $labels.reciping_team }}, ì„œë¹„ìŠ¤={{ $labels.reciping_service }}ì˜ P95 ì§€ì—°ì´ 10ë¶„ ë™ì•ˆ 500msë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."

        - alert: ServiceLatencyP99High
          expr: |
            histogram_quantile(0.99,
              sum by (le,reciping_team,reciping_service) (
                rate(http_server_requests_seconds_bucket{uri!~"/actuator/.*"}[5m])
              )
            ) > 1
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "[ğŸš¨ì¹˜ëª…ì  - critical] P99 ì§€ì—° ì‹œê°„ ë§¤ìš° ë†’ìŒ (>1s)"
            description: "íŒ€={{ $labels.reciping_team }}, ì„œë¹„ìŠ¤={{ $labels.reciping_service }}ì˜ P99 ì§€ì—°ì´ 5ë¶„ ë™ì•ˆ 1ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."

    # 3) íŠ¸ë˜í”½/ì—ëŸ¬ìœ¨ ì´ìƒ ê°ì§€(ë² ì´ìŠ¤ë¼ì¸ ëŒ€ë¹„ í¸ì°¨)
    - name: http-anomaly
      rules:
        - alert: ServiceTrafficAnomaly
          expr: |
            # ìµœê·¼ 5ë¶„ RPS
            (
              sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m]))
              -
              avg_over_time(sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m]))[1h])
            )
            /
            stddev_over_time(sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m]))[1h])
            > 3
            and
            sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m])) > 0.1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "[ğŸš¨ê²½ê³  - warning] íŠ¸ë˜í”½ ì´ìƒ ê°ì§€"
            description: "íŒ€={{ $labels.reciping_team }}, ì„œë¹„ìŠ¤={{ $labels.reciping_service }}ì˜ RPSê°€ ìµœê·¼ 1ì‹œê°„ ê¸°ì¤€ì„  ëŒ€ë¹„ 3Ïƒ ì´ìƒ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤(10ë¶„ ì§€ì†)."

        - alert: ServiceErrorRateAnomaly
          expr: |
            # ìµœê·¼ 5ë¶„ ì—ëŸ¬ìœ¨ z-score
            (
              (
                sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{status=~"5..",uri!~"/actuator/.*"}[5m]))
                /
                sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m]))
              )
              -
              avg_over_time(
                (
                  sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{status=~"5..",uri!~"/actuator/.*"}[5m]))
                  /
                  sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m]))
                )[1h]
              )
            )
            /
            stddev_over_time(
              (
                sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{status=~"5..",uri!~"/actuator/.*"}[5m]))
                /
                sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m]))
              )[1h]
            ) > 3
            and
            sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m])) > 0.1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "[ğŸš¨ê²½ê³  - warning] ì˜¤ë¥˜ìœ¨ ì´ìƒ ê°ì§€"
            description: "íŒ€={{ $labels.reciping_team }}, ì„œë¹„ìŠ¤={{ $labels.reciping_service }}ì˜ ì˜¤ë¥˜ìœ¨ì´ ìµœê·¼ 1ì‹œê°„ ê¸°ì¤€ì„  ëŒ€ë¹„ 3Ïƒ ì´ìƒ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤(10ë¶„ ì§€ì†)."

    # 4) JVM/ë¦¬ì†ŒìŠ¤(ì• í”Œë¦¬ì¼€ì´ì…˜ ê´€ì )
    - name: jvm-and-runtime
      rules:
        - alert: JvmHeapUsageHigh
          expr: |
            max by (reciping_team,reciping_service) (
              jvm_memory_used_bytes{area="heap"}
              /
              jvm_memory_max_bytes{area="heap"}
            ) > 0.9
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "[ğŸš¨ê²½ê³  - warning] JVM Heap ì‚¬ìš©ë¥  ë†’ìŒ (>90%)"
            description: "íŒ€={{ $labels.reciping_team }}, ì„œë¹„ìŠ¤={{ $labels.reciping_service }}ì˜ JVM Heap ì‚¬ìš©ë¥ ì´ 10ë¶„ ë™ì•ˆ 90%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."

        - alert: ContainerRestarts
          expr: |
            increase(kube_pod_container_status_restarts_total{namespace="reciping"}[5m]) > 0
          for: 0m
          labels:
            severity: warning
          annotations:
            summary: "[ğŸš¨ê²½ê³  - warning] ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ë°œìƒ"
            description: "namespace=reciping, pod={{ $labels.pod }}, container={{ $labels.container }}ì—ì„œ ì¬ì‹œì‘ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
