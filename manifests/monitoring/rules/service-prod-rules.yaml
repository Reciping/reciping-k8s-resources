apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: service-prod-rules
  namespace: monitoring
spec:
  groups:
    # 1) 가용성/오류율
    - name: http-availability
      rules:
        - alert: ServiceErrorRateHighWarning
          expr: |
            (
              sum by (reciping_team,reciping_service) (
                rate(http_server_requests_seconds_count{status=~"5..",uri!~"/actuator/.*"}[5m])
              )
              /
              sum by (reciping_team,reciping_service) (
                rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m])
              )
            ) > 0.05
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "[🚨경고 - warning] 5xx 오류율 높음"
            description: "팀={{ $labels.reciping_team }}, 서비스={{ $labels.reciping_service }}의 5xx 오류율이 10분 동안 5%를 초과했습니다."

        - alert: ServiceErrorRateHighCritical
          expr: |
            (
              sum by (reciping_team,reciping_service) (
                rate(http_server_requests_seconds_count{status=~"5..",uri!~"/actuator/.*"}[5m])
              )
              /
              sum by (reciping_team,reciping_service) (
                rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m])
              )
            ) > 0.10
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "[🚨치명적 - critical] 5xx 오류율 매우 높음"
            description: "팀={{ $labels.reciping_team }}, 서비스={{ $labels.reciping_service }}의 5xx 오류율이 5분 동안 10%를 초과했습니다."

        - alert: ServiceInstancesDown
          expr: |
            min by (reciping_team,reciping_service) (up{namespace="reciping"}) == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "[🚨치명적 - critical] 모든 인스턴스 다운"
            description: "팀={{ $labels.reciping_team }}, 서비스={{ $labels.reciping_service }}의 모든 스크레이프 대상이 Down 상태입니다."

    # 2) 지연 시간 (퍼센타일)
    - name: http-latency
      rules:
        - alert: ServiceLatencyP95High
          expr: |
            histogram_quantile(0.95,
              sum by (le,reciping_team,reciping_service) (
                rate(http_server_requests_seconds_bucket{uri!~"/actuator/.*"}[5m])
              )
            ) > 0.5
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "[🚨경고 - warning] P95 지연 시간 높음 (>500ms)"
            description: "팀={{ $labels.reciping_team }}, 서비스={{ $labels.reciping_service }}의 P95 지연이 10분 동안 500ms를 초과했습니다."

        - alert: ServiceLatencyP99High
          expr: |
            histogram_quantile(0.99,
              sum by (le,reciping_team,reciping_service) (
                rate(http_server_requests_seconds_bucket{uri!~"/actuator/.*"}[5m])
              )
            ) > 1
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "[🚨치명적 - critical] P99 지연 시간 매우 높음 (>1s)"
            description: "팀={{ $labels.reciping_team }}, 서비스={{ $labels.reciping_service }}의 P99 지연이 5분 동안 1초를 초과했습니다."

    # 3) 트래픽/에러율 이상 감지(베이스라인 대비 편차)
    - name: http-anomaly
      rules:
        - alert: ServiceTrafficAnomaly
          expr: |
            # 최근 5분 RPS
            (
              sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m]))
              -
              avg_over_time(sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m]))[1h])
            )
            /
            stddev_over_time(sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m]))[1h])
            > 3
            and
            sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m])) > 0.1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "[🚨경고 - warning] 트래픽 이상 감지"
            description: "팀={{ $labels.reciping_team }}, 서비스={{ $labels.reciping_service }}의 RPS가 최근 1시간 기준선 대비 3σ 이상 벗어났습니다(10분 지속)."

        - alert: ServiceErrorRateAnomaly
          expr: |
            # 최근 5분 에러율 z-score
            (
              (
                sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{status=~"5..",uri!~"/actuator/.*"}[5m]))
                /
                sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m]))
              )
              -
              avg_over_time(
                (
                  sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{status=~"5..",uri!~"/actuator/.*"}[5m]))
                  /
                  sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m]))
                )[1h]
              )
            )
            /
            stddev_over_time(
              (
                sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{status=~"5..",uri!~"/actuator/.*"}[5m]))
                /
                sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m]))
              )[1h]
            ) > 3
            and
            sum by (reciping_team,reciping_service) (rate(http_server_requests_seconds_count{uri!~"/actuator/.*"}[5m])) > 0.1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "[🚨경고 - warning] 오류율 이상 감지"
            description: "팀={{ $labels.reciping_team }}, 서비스={{ $labels.reciping_service }}의 오류율이 최근 1시간 기준선 대비 3σ 이상 벗어났습니다(10분 지속)."

    # 4) JVM/리소스(애플리케이션 관점)
    - name: jvm-and-runtime
      rules:
        - alert: JvmHeapUsageHigh
          expr: |
            max by (reciping_team,reciping_service) (
              jvm_memory_used_bytes{area="heap"}
              /
              jvm_memory_max_bytes{area="heap"}
            ) > 0.9
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "[🚨경고 - warning] JVM Heap 사용률 높음 (>90%)"
            description: "팀={{ $labels.reciping_team }}, 서비스={{ $labels.reciping_service }}의 JVM Heap 사용률이 10분 동안 90%를 초과했습니다."

        - alert: ContainerRestarts
          expr: |
            increase(kube_pod_container_status_restarts_total{namespace="reciping"}[5m]) > 0
          for: 0m
          labels:
            severity: warning
          annotations:
            summary: "[🚨경고 - warning] 컨테이너 재시작 발생"
            description: "namespace=reciping, pod={{ $labels.pod }}, container={{ $labels.container }}에서 재시작이 발생했습니다."
